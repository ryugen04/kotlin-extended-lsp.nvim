name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: v<major>.<minor>.<patch> (e.g., v1.0.0)"
            exit 1
          fi
          echo "‚úÖ Version format valid"

      - name: Check if tag exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "‚úÖ Tag exists: $VERSION"
          else
            echo "‚ö†Ô∏è  Tag does not exist: $VERSION"
          fi

  test:
    name: Run Full Test Suite
    needs: validate
    uses: ./.github/workflows/ci.yml

  build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [validate, test]
    steps:
      - uses: actions/checkout@v4

      - name: Create release archive
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          ARCHIVE_NAME="kotlin-extended-lsp-nvim-${VERSION}.tar.gz"

          # Create archive excluding unnecessary files
          tar -czf "$ARCHIVE_NAME" \
            --exclude='.git*' \
            --exclude='test-project' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            lua/ \
            plugin/ \
            doc/ \
            README.md \
            LICENSE \
            CONTRIBUTING.md

          echo "üì¶ Created: $ARCHIVE_NAME"
          ls -lh "$ARCHIVE_NAME"

      - name: Generate checksums
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          ARCHIVE_NAME="kotlin-extended-lsp-nvim-${VERSION}.tar.gz"

          sha256sum "$ARCHIVE_NAME" > "${ARCHIVE_NAME}.sha256"
          sha512sum "$ARCHIVE_NAME" > "${ARCHIVE_NAME}.sha512"

          echo "‚úÖ Checksums generated"
          cat "${ARCHIVE_NAME}.sha256"
          cat "${ARCHIVE_NAME}.sha512"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            kotlin-extended-lsp-nvim-*.tar.gz
            kotlin-extended-lsp-nvim-*.sha256
            kotlin-extended-lsp-nvim-*.sha512

  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        env:
          REPO: ${{ github.repository }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "$VERSION^" 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "First release, showing all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Changes since $PREVIOUS_TAG"
            COMMITS=$(git log "$PREVIOUS_TAG..$VERSION" --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save to output (handle multiline)
          {
            echo "changelog<<EOF"
            echo "## What's Changed"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "**Full Changelog**: https://github.com/${REPO}/compare/${PREVIOUS_TAG}...${VERSION}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build, changelog]
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body: ${{ needs.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          files: |
            kotlin-extended-lsp-nvim-*.tar.gz
            kotlin-extended-lsp-nvim-*.sha256
            kotlin-extended-lsp-nvim-*.sha512
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "### üéâ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL**: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
